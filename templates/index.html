{% extends 'base.html' %} {% block content %}

<div class="w3-row-padding w3-padding">
  <!-- LEFT FORM -->
  <div class="w3-third w3-mobile">
    <div class="w3-card-4 w3-padding w3-round-large" style="background: white">
      <fieldset class="w3-round-large" style="border: 1px solid #ccc">
        <legend><b>STUDENT INFORMATION</b></legend>

        <form
          action="{{ url_for('add_student') }}"
          method="POST"
          id="studentForm"
        >
          <center>
            <img
              id="profilePreview"
              src="{{ url_for('static', filename='images/account.png') }}"
              style="
                width: 140px;
                height: 140px;
                border-radius: 50%;
                object-fit: cover;
                border: 3px solid #ddd;
                margin: 10px;
              "
            />

            <input
              type="file"
              id="photoInput"
              accept="image/*"
              class="w3-input w3-round"
            />

            <button
              type="button"
              class="w3-button w3-blue w3-round w3-small w3-margin-top"
              onclick="uploadPhoto()"
            >
              Upload Photo
            </button>
          </center>

          <p>
            <label><b>IDNO</b></label>
            <input
              type="number"
              name="idno"
              id="idno"
              class="w3-input w3-border"
              required
            />
          </p>

          <p>
            <label><b>LASTNAME</b></label>
            <input
              type="text"
              name="lastname"
              id="lastname"
              class="w3-input w3-border"
              required
            />
          </p>

          <p>
            <label><b>FIRSTNAME</b></label>
            <input
              type="text"
              name="firstname"
              id="firstname"
              class="w3-input w3-border"
              required
            />
          </p>

          <p>
            <label><b>COURSE</b></label>
            <select
              name="course"
              id="course"
              class="w3-input w3-border"
              required
            >
              <option value="BSIT">INFORMATION TECHNOLOGY</option>
              <option value="BSCS">COMPUTER SCIENCE</option>
              <option value="BSCPE">COMPUTER ENGINEERING</option>
              <option value="BSCRIM">CRIMINOLOGY</option>
              <option value="BSHM">HOSPITALITY MANAGEMENT</option>
              <option value="BSN">NURSING</option>
            </select>
          </p>

          <p>
            <label><b>YEAR LEVEL</b></label>
            <select name="level" id="level" class="w3-input w3-border" required>
              <option value="1">FIRST YEAR</option>
              <option value="2">SECOND YEAR</option>
              <option value="3">THIRD YEAR</option>
              <option value="4">FOURTH YEAR</option>
            </select>
          </p>

          <p class="w3-center">
            <input
              type="submit"
              value="SAVE"
              class="w3-button w3-green w3-round-large"
            />
            <input
              type="reset"
              value="CANCEL"
              class="w3-button w3-red w3-round-large"
            />
          </p>
        </form>
      </fieldset>
    </div>
  </div>

  <!-- RIGHT SIDE STUDENT LIST -->
  <div class="w3-twothird w3-mobile">
    <div class="w3-card w3-round-large w3-padding" style="background: white">
      <h4><b>STUDENT LIST ({{ studentlist|length }})</b></h4>

      <!-- SEARCH FILTER -->
      <input
        type="text"
        id="searchBox"
        class="w3-input w3-border w3-round w3-margin-bottom"
        placeholder="Search by ID, Name, Course..."
        onkeyup="filterTable()"
      />

      <div style="overflow-x: auto">
        <table
          class="w3-table-all w3-hoverable w3-round-large"
          id="studentTable"
        >
          <tr style="background: #eaeaea">
            <th>PHOTO</th>
            <th>IDNO</th>
            <th>LASTNAME</th>
            <th>FIRSTNAME</th>
            <th>COURSE</th>
            <th>LEVEL</th>
            <th>ACTION</th>
          </tr>

          {% for student in studentlist %}
          <tr>
            <td>
              <img
                src="/static/images/{{ student.idno }}.jpg"
                onerror="this.src='/static/images/account.png'"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  object-fit: cover;
                "
              />
            </td>

            <td>{{ student.idno }}</td>
            <td>{{ student.lastname }}</td>
            <td>{{ student.firstname }}</td>
            <td>{{ student.course }}</td>
            <td>{{ student.level }}</td>

            <td>
              <button
                class="w3-button w3-light-grey w3-round-small"
                data-idno="{{ student.idno }}"
                data-lastname="{{ student.lastname }}"
                data-firstname="{{ student.firstname }}"
                data-course="{{ student.course }}"
                data-level="{{ student.level }}"
                onclick="editStudentFromButton(this)"
              >
                ‚úèÔ∏è
              </button>

              <a
                href="{{ url_for('delete_student', idno=student.idno) }}"
                class="w3-button w3-red w3-round-small"
                onclick="return confirm('Delete this student?');"
                >üóëÔ∏è</a
              >
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
  function uploadPhoto() {
    let idno = document.getElementById("idno").value;
    let file = document.getElementById("photoInput").files[0];

    if (!idno) return showMessage("Enter IDNO before uploading!", "red");
    if (!file) return showMessage("Choose a photo first!", "red");

    let formData = new FormData();
    formData.append("photo", file);
    formData.append("idno", idno);

    fetch("/upload-photo", { method: "POST", body: formData })
      .then((res) => res.json())
      .then((data) => {
        // Show success message WITHOUT refresh
        showMessage(data.message, "green");

        const newUrl =
          "/static/images/" + idno + ".jpg?" + new Date().getTime();

        // Update form preview
        document.getElementById("profilePreview").src = newUrl;

        // Update table photo dynamically
        const imgRows = document.querySelectorAll(`img[src*="${idno}.jpg"]`);
        imgRows.forEach((img) => (img.src = newUrl));
      });
  }

  function editStudentFromButton(btn) {
    document.getElementById("idno").value = btn.dataset.idno;
    document.getElementById("lastname").value = btn.dataset.lastname;
    document.getElementById("firstname").value = btn.dataset.firstname;
    document.getElementById("course").value = btn.dataset.course;
    document.getElementById("level").value = btn.dataset.level;

    document.getElementById("profilePreview").src =
      "/static/images/" + btn.dataset.idno + ".jpg?" + new Date().getTime();

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // REAL-TIME SEARCH FILTER
  function filterTable() {
    let filter = document.getElementById("searchBox").value.toUpperCase();
    let table = document.getElementById("studentTable");
    let tr = table.getElementsByTagName("tr");

    for (let i = 1; i < tr.length; i++) {
      let row = tr[i].innerText.toUpperCase();
      tr[i].style.display = row.includes(filter) ? "" : "none";
    }
  }
</script>

{% endblock %}
